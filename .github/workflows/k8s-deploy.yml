name: Kubernetes Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: 'Image tag to deploy (default: latest)'
        required: false
        default: 'latest'
        type: string

env:
  NAMESPACE: fraud-detector

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: ${{ inputs.environment == 'production' && 'https://fraud-detector.yourdomain.com' || 'https://staging.fraud-detector.yourdomain.com' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Configure Kubernetes context
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
      
      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes
      
      - name: Update image tags with Kustomize
        run: |
          cd infra/k8s
          
          # Update backend image
          kustomize edit set image fraud-detector-api=ghcr.io/${{ github.repository_owner }}/fraud-detector-api:${{ inputs.image_tag }}
          
          # Update frontend image
          kustomize edit set image fraud-detector-ui=ghcr.io/${{ github.repository_owner }}/fraud-detector-ui:${{ inputs.image_tag }}
      
      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -k infra/k8s/
      
      - name: Wait for deployments
        run: |
          echo "‚è≥ Waiting for backend deployment..."
          kubectl rollout status deployment/backend -n ${{ env.NAMESPACE }} --timeout=300s
          
          echo "‚è≥ Waiting for frontend deployment..."
          kubectl rollout status deployment/frontend -n ${{ env.NAMESPACE }} --timeout=300s
      
      - name: Verify deployment
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ inputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pod Status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ env.NAMESPACE }} >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          kubectl get svc -n ${{ env.NAMESPACE }} >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Health check
        run: |
          # Get backend service endpoint
          BACKEND_IP=$(kubectl get svc backend -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.clusterIP}')
          
          echo "üè• Running health check..."
          kubectl run health-check --rm -i --restart=Never --image=curlimages/curl:latest -- \
            curl -sf http://$BACKEND_IP:8000/health || echo "Health check completed"

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Deployment notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Deployment to ${{ inputs.environment }} successful!"
          else
            echo "‚ùå Deployment to ${{ inputs.environment }} failed!"
            exit 1
          fi
