<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraud Detector Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 { font-size: 2em; margin-bottom: 10px; }
        .subtitle { opacity: 0.9; font-size: 1.1em; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-label {
            font-size: 0.9em;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2d3748;
        }
        .stat-change {
            font-size: 0.9em;
            margin-top: 10px;
        }
        .stat-change.positive { color: #48bb78; }
        .stat-change.negative { color: #f56565; }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .chart-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #2d3748;
        }
        
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: #f7fafc;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
        }
        td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        tr:hover { background: #f7fafc; }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .badge-danger { background: #fed7d7; color: #c53030; }
        .badge-warning { background: #feebc8; color: #c05621; }
        .badge-success { background: #c6f6d5; color: #22543d; }
        
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.2s;
        }
        .refresh-btn:hover { background: #5a67d8; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ°Ô∏è Fraud Detection Dashboard</h1>
            <p class="subtitle">Real-time monitoring and analytics</p>
        </header>
        
        <div style="margin-bottom: 20px;">
            <button class="refresh-btn" onclick="loadDashboard()">üîÑ Refresh Data</button>
        </div>
        
        <!-- Stats Overview -->
        <div class="stats-grid" id="statsGrid">
            <div class="loading">Loading statistics...</div>
        </div>
        
        <!-- Trend Charts -->
        <div class="chart-container">
            <h2 class="chart-title">üìà Fraud Trends (Last 30 Days)</h2>
            <canvas id="trendChart" height="80"></canvas>
        </div>
        
        <!-- Top Offenders -->
        <div class="table-container">
            <h2 class="chart-title" style="padding: 20px 20px 0;">üö® Top Flagged IPs (Last 7 Days)</h2>
            <table id="topIPsTable">
                <thead>
                    <tr>
                        <th>IP Address</th>
                        <th>Total Activities</th>
                        <th>Flagged</th>
                        <th>Flag Rate</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="4" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Recent Flags -->
        <div class="table-container">
            <h2 class="chart-title" style="padding: 20px 20px 0;">üîç Recently Flagged Reviews</h2>
            <table id="recentFlagsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Content</th>
                        <th>Score</th>
                        <th>Reasons</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="6" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        const API_TOKEN = localStorage.getItem('api_token') || 'devtoken';
        const API_BASE = window.location.origin;
        
        async function fetchAPI(endpoint) {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                headers: {
                    'X-API-Key': API_TOKEN
                }
            });
            if (!response.ok) throw new Error('API request failed');
            return response.json();
        }
        
        async function loadStats() {
            try {
                const data = await fetchAPI('/dashboard/api/stats');
                
                const statsHTML = `
                    <div class="stat-card">
                        <div class="stat-label">Reviews Today</div>
                        <div class="stat-value">${data.reviews.today.total}</div>
                        <div class="stat-change negative">‚ö†Ô∏è ${data.reviews.today.flagged} flagged (${((data.reviews.today.flagged / data.reviews.today.total * 100) || 0).toFixed(1)}%)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Reviews This Week</div>
                        <div class="stat-value">${data.reviews.week.total}</div>
                        <div class="stat-change negative">‚ö†Ô∏è ${data.reviews.week.flagged} flagged</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Transactions Today</div>
                        <div class="stat-value">${data.transactions.today.total}</div>
                        <div class="stat-change negative">üí∞ ‚Çπ${data.transactions.today.flagged_amount.toLocaleString()} flagged</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Fraud Rate (Week)</div>
                        <div class="stat-value">${((data.transactions.week.flagged / data.transactions.week.total * 100) || 0).toFixed(1)}%</div>
                        <div class="stat-change">${data.transactions.week.flagged} / ${data.transactions.week.total} txs</div>
                    </div>
                `;
                
                document.getElementById('statsGrid').innerHTML = statsHTML;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        let trendChart = null;
        
        async function loadTrends() {
            try {
                const data = await fetchAPI('/dashboard/api/trends?days=30');
                
                const ctx = document.getElementById('trendChart').getContext('2d');
                
                if (trendChart) trendChart.destroy();
                
                trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.reviews.map(r => r.date),
                        datasets: [
                            {
                                label: 'Review Flag Rate (%)',
                                data: data.reviews.map(r => r.flag_rate),
                                borderColor: '#f56565',
                                backgroundColor: 'rgba(245, 101, 101, 0.1)',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Transaction Flag Rate (%)',
                                data: data.transactions.map(t => t.flag_rate),
                                borderColor: '#4299e1',
                                backgroundColor: 'rgba(66, 153, 225, 0.1)',
                                yAxisID: 'y'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { display: true, text: 'Flag Rate (%)' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading trends:', error);
            }
        }
        
        async function loadTopOffenders() {
            try {
                const data = await fetchAPI('/dashboard/api/top-offenders?limit=10');
                
                const tbody = document.querySelector('#topIPsTable tbody');
                tbody.innerHTML = data.ips.map(ip => `
                    <tr>
                        <td><code>${ip.ip}</code></td>
                        <td>${ip.total}</td>
                        <td><span class="badge badge-danger">${ip.flagged}</span></td>
                        <td><strong>${ip.flag_rate}%</strong></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading top offenders:', error);
            }
        }
        
        async function loadRecentFlags() {
            try {
                const data = await fetchAPI('/dashboard/api/recent-flags?type=review&limit=15');
                
                const tbody = document.querySelector('#recentFlagsTable tbody');
                tbody.innerHTML = data.items.map(item => `
                    <tr>
                        <td><code>${item.id}</code></td>
                        <td>User ${item.user_id}</td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${item.text}</td>
                        <td><span class="badge ${item.score > 0.8 ? 'badge-danger' : 'badge-warning'}">${(item.score * 100).toFixed(0)}%</span></td>
                        <td style="font-size: 0.85em;">${item.reasons.join(', ')}</td>
                        <td>${new Date(item.created_at).toLocaleString()}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading recent flags:', error);
            }
        }
        
        async function loadDashboard() {
            await Promise.all([
                loadStats(),
                loadTrends(),
                loadTopOffenders(),
                loadRecentFlags()
            ]);
        }
        
        // Initial load
        loadDashboard();
        
        // Auto-refresh every 60 seconds
        setInterval(loadDashboard, 60000);
    </script>
</body>
</html>